name: Terraform Stage 1 - Security Scans

on:
  push:
    branches-ignore:
      - main

permissions:
  security-events: write
  id-token: write

env:
  TF_VERSION: '1.14.3'
  TERRAFORM_WORKING_DIR: '.'
  TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}

jobs:
  # Stage 1.1: Run Terrascan on feature branch push
  terrascan:
    name: Terrascan Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Terrascan
        uses: tenable/terrascan-action@main
        with:
          iac_type: 'terraform'
          iac_version: 'v14'
          policy_type: 'azure'
          only_warn: true
          sarif_upload: true
          non_recursive: false
          iac_dir: ${{ env.TERRAFORM_WORKING_DIR }}

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: terrascan.sarif

  # Stage 1.2: Run Checkov on feature branch push
  checkov:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ env.TERRAFORM_WORKING_DIR }}
          framework: terraform
          output_format: cli,sarif
          output_file_path: checkov.sarif
          soft_fail: false
        continue-on-error: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov.sarif

      - name: Fail if Checkov found issues
        if: steps.checkov.outcome == 'failure'
        run: exit 1
