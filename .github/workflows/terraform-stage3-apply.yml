name: Terraform Stage 3 - Apply

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  TF_VERSION: '1.14.3'
  TERRAFORM_WORKING_DIR: '.'
  TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

jobs:
  # Stage 3.0: Detect changed environment folders
  detect-changes:
    name: Detect Changed Environments
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed environment folders
        id: set-matrix
        run: |
          # Get the base branch
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}
          
          # Find all environment folders that have changes
          changed_folders=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep "^Environments/" | cut -d'/' -f2 | sort -u)
          
          # Build JSON array for matrix
          if [ -z "$changed_folders" ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"environment\":[]}" >> $GITHUB_OUTPUT
            echo "No changes detected in Environments folder"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            matrix_json=$(echo "$changed_folders" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "matrix={\"environment\":$matrix_json}" >> $GITHUB_OUTPUT
            echo "Changed environments: $changed_folders"
          fi

  # Stage 3: Run Terraform apply after manual approval
  terraform-apply:
    name: Terraform Apply - ${{ matrix.environment }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    environment:
      name: deploy
      url: https://github.com/${{ github.repository }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: terraform init -backend-config="key=${{ matrix.environment }}.tfstate"
        working-directory: Environments/${{ matrix.environment }}

      - name: Get Stage 2 Run ID
        id: get-run-id
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'terraform-stage2-plan.yml',
              event: 'pull_request',
              status: 'completed',
              per_page: 100
            });
            
            const prNumber = context.payload.pull_request.number;
            const runForThisPR = workflowRuns.workflow_runs.find(run => 
              run.pull_requests.some(pr => pr.number === prNumber)
            );
            
            if (!runForThisPR) {
              core.setFailed(`No completed stage2 run found for PR #${prNumber}`);
              return;
            }
            
            core.setOutput('run-id', runForThisPR.id);
            console.log(`Found stage2 run ID: ${runForThisPR.id}`);

      - name: Download Plan File
        uses: actions/download-artifact@v5
        with:
          name: terraform-plan-${{ matrix.environment }}-${{ github.event.pull_request.number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.get-run-id.outputs.run-id }}
          path: Environments/${{ matrix.environment }}

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve -input=false tfplan
        working-directory: Environments/${{ matrix.environment }}

      - name: Post Apply Result to PR
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### Terraform Apply ðŸš€ - ${{ matrix.environment }}
            
            **Apply Status:** ${{ steps.apply.outcome }}
            **Environment:** ${{ matrix.environment }}
            **Workflow:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Approved by:** @${{ github.actor }}
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });
